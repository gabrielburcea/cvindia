---
title: "Test"
author: "Gabriel Burcea"
date: "31/08/2020"
output: word_document
---



```{r  include=FALSE, echo=TRUE}


library(tidymodels)
library(readr)
library(dplyr)
library(corrr)
library(tidyverse)
library(conflicted)
library(tidymodels)
library(ggrepel)
library(corrplot)
library(dplyr)
library(corrr) 
library(themis)
library(rsample)
library(caret)
library(forcats)
library(rcompanion)
library(MASS)
library(pROC)
library(ROCR)
library(data.table)
library(ggplot2)
library(qgraph)
library(report)
library(corrplot)

conflict_prefer("step", "stats")

### ML for Mixed - categorical and numerica data ####

```


```{r sympt-pos}

library(tidyverse)

data_categ_nosev <- readr::read_csv("/Users/gabrielburcea/Rprojects/stats_data_whole/data_categ_nosev_comorbidity_one.csv")

data_categ_nosev %>% distinct(chills)



# data_categ_nosev <- data_categ_nosev %>%
#   dplyr::mutate(covid_tested = forcats::fct_recode(covid_tested, !!!level_covid_tested))


count_covid_st <- data_categ_nosev %>%
  dplyr::select(id, covid_tested) %>%
  dplyr::group_by(covid_tested) %>%
  dplyr::tally() %>%
  dplyr::mutate(Percent = n/sum(n)*100)

data_categ_nosev %>% dplyr::distinct(sneezing)



level_gender <- c("Other" = "Gender")


data_categ_nosev <- data_categ_nosev %>%
  dplyr::mutate(gender = fct_recode(gender, !!!level_gender))



data_categ_nosev %>% distinct(gender)
count_gender <- data_categ_nosev %>%
  dplyr::group_by(gender) %>%
  dplyr::summarise(Count = n()) %>%
  dplyr::mutate(Frequency = Count/sum(Count)*100)



data_categ_nosev <- data_categ_nosev %>%
  dplyr::mutate(age_band = dplyr::case_when(
    age == 0 | age <= 20 ~ '0-20',
    age == 21 | age <= 30 ~ '21-30',
    age == 31 | age <= 40 ~ '31-40',
    age == 41 | age <= 50 ~ '41-50',
    age == 51 | age <= 60 ~ '51-60',
    age == 61 | age <= 70 ~ '61-70',
    age == 71 | age <= 80 ~ '71-80',
    age == 81 | age <= 90 ~ '81-100'))

count_age <- data_categ_nosev %>%
  dplyr::group_by(age_band) %>%
  dplyr::summarise(Count = n()) %>%
  dplyr::mutate(Frequency = Count/sum(Count)*100)

as.data.frame(count_age)

knitr::kable(count_age)

data_categ_nosev<- dplyr::mutate(data_categ_nosev, 
                            n_cmdt =  ifelse(number_morbidities %in% 0 , "no morbidity", 
                                      ifelse(number_morbidities %in% 1, "1 morbidity", 
                                      ifelse(number_morbidities %in% 2 , "2 comorbidities",        
                                      ifelse(number_morbidities %in% 3:99, ">3 comorbidites", NA)))))

data_categ_nosev$number_morbidities <- as.factor(data_categ_nosev$number_morbidities)

count_comorbidities <- data_categ_nosev %>%
  dplyr::group_by(n_cmdt) %>%
  tally() %>%
  dplyr::mutate(Frequency = n/sum(n) *100)


level_covid_tested <- c("positive" = "Tested Positive,Self-Isolating With No Symptoms",
                        "positive" = "Tested Positive,Tested Negative But Have Symptoms,Showing Symptoms But Not Tested,Recovered But Have New Symptoms,Curious,Self-Isolating With No Symptoms")

data_categ_nosev <- data_categ_nosev %>%
  dplyr::filter(covid_tested != 'none') %>%
  dplyr::mutate(status_cv = dplyr::case_when(covid_tested == 'showing symptoms' ~ 0,
                                             covid_tested == 'positive' ~ 1)) %>%
  tidyr::drop_na()


```


How many male and female we have in our dataset? There are 5083 male accounting for 53 percent whilst female are 4321 accounting for 45 percent. Also, we have very low percent of other group.


```{r, gender-pie, echo=F, results= 'asis', fig.height=5, fig.width=7}

gender_tb <- data_categ_nosev %>%
  dplyr::select(id, gender) %>%
  dplyr::group_by(gender) %>%
  dplyr::tally() %>%
  dplyr::mutate(percent = n/sum(n))

gender_tb

bp <- ggplot2::ggplot(gender_tb, ggplot2::aes(x = "", y = percent, fill = gender)) + 
  ggplot2::geom_bar(width = 1, stat = "identity")

pie <- bp + ggplot2::coord_polar("y", start = 0) + 
  ggplot2::scale_fill_brewer(palette = "Blues") +
  ggplot2::theme(axis.text.x = ggplot2::element_blank())

pie
```



```{r}

library(report)

# data_categ_nosev <- data_categ_nosev %>%
#   dplyr::filter(covid_tested != 'none') %>%
#   dplyr::mutate(status_cv = dplyr::case_when(
#                                              covid_tested == 'showing symptoms' ~ 0,
#                                              covid_tested == 'positive' ~ 1), 
#                 number_comorbidities = dplyr::case_when(number_morbidities == 1 ~ 'one', 
#                                                         number_morbidities >= 2 ~ 'more than 2')) %>%
#   
#   tidyr::drop_na()
# 
# data_categ_nosev <- data_categ_nosev %>% dplyr::rename(id = ID, covid_tested = Covid_tested, gender = Gender, age = Age)

show_sympt_positive <- data_categ_nosev %>%
  dplyr::select(id, status_cv) %>%
  dplyr::group_by(status_cv) %>%
  dplyr::tally()

knitr::kable(show_sympt_positive)

  
```


```{r  include=FALSE, echo=TRUE}


library(tidymodels)
library(readr)
library(dplyr)
library(corrr)
library(tidyverse)
library(conflicted)
library(tidymodels)
library(ggrepel)
library(corrplot)
library(dplyr)
library(corrr) 
library(themis)
library(rsample)
library(caret)
library(forcats)
library(rcompanion)
library(MASS)
library(pROC)
library(ROCR)
library(data.table)
library(ggplot2)
library(qgraph)
library(report)
library(corrplot)

conflict_prefer("step", "stats")

### ML for Mixed - categorical and numerica data ####

```


# Correlations 

Correlations matrix is done on numerical variables. However, I have transformed the categorical variables into numerical ones, as I cannot correlate all categorical variables once. Additionally, the correlation is done on original dataset and not on the 9436 datasets since a lot of respondents that declared they have no covid have reported some covid symptoms. However, this has to be discussed more in detail and wait for a bigger dataset. 

From the correlation matrix, it is noticed, fatigue and muscle ache seem to be correlated, but only with 0.43550, the highest correlation. Yet, for the highest correlation, it is not even passing the 0.5. However, I choose to take out of the analysis the fatigue variable. 


```{r corelations, echo=F, results= 'asis', fig.height=5, fig.width=7}
###################################
#######Corelations ################


data_cor <- data_categ_nosev
data_cor <- data_categ_nosev %>%
  dplyr::select(chills, cough, diarrhoea, fatigue, headache, loss_smell_taste, muscle_ache, nasal_congestion, 
         nausea_vomiting, shortness_breath, sore_throat, sputum, temperature, loss_appetite, chest_pain, itchy_eyes, 
         joint_pain, asthma, diabetes_type_one, diabetes_type_two, obesity, hypertension, heart_disease, lung_condition, liver_disease, 
         kidney_disease)

correlations <- cor_auto(data_cor)


corrplot(correlations, type = "upper", order = "hclust", tl.col = "black", tl.srt = 45)



```





```{r}


obesity_data <- data_categ_nosev %>%
  dplyr::select(obesity, gender, chills, cough, diarrhoea, headache, loss_smell_taste, muscle_ache, 
                nasal_congestion, nausea_vomiting, shortness_breath, sore_throat, sputum, temperature, loss_appetite, chest_pain, itchy_eyes, joint_pain) %>%
  tidyr::drop_na() %>%
  dplyr::select(-gender)
```





```{r}
obesity_model <- glm(obesity ~ cough + diarrhoea + shortness_breath + temperature + loss_smell_taste + headache + muscle_ache + nasal_congestion + itchy_eyes + loss_appetite,  data = obesity_data, family = binomial)

summary(obesity_model)


# odds ratio and 95% CL

knitr::kable(exp(cbind(OR = coef(obesity_model), confint(obesity_model))))

```